<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剪刀石头布</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status {
            font-size: 1.5em;
            margin-bottom: 30px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            color: #555;
        }

        .players {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }

        .player {
            padding: 20px;
            border-radius: 10px;
            min-width: 150px;
        }

        .player1 {
            background: #e3f2fd;
        }

        .player2 {
            background: #fce4ec;
        }

        .player h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .choice {
            font-size: 3em;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 20px 40px;
            font-size: 1.5em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            font-size: 2em;
            font-weight: bold;
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .winner {
            background: #4caf50;
            color: white;
        }

        .draw {
            background: #ff9800;
            color: white;
        }

        .reset {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 1.2em;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }

        .reset:hover {
            background: #d32f2f;
        }

        .mode-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .game-area {
            display: none;
        }

        .game-area.active {
            display: block;
        }

        .online-match-btn {
            padding: 20px 40px;
            font-size: 1.5em;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            margin-top: 20px;
        }

        .online-match-btn:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
        }

        .online-match-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .room-input-container {
            margin-top: 20px;
        }

        .room-input {
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 20px;
            text-align: center;
        }

        .room-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .room-status {
            font-size: 1.1em;
            color: #666;
            margin-top: 15px;
            min-height: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>剪刀石头布</h1>
        
        <div class="mode-selection">
            <button class="mode-btn active" id="pvp-btn" onclick="selectMode('pvp')">玩家对战</button>
            <button class="mode-btn" id="pvc-btn" onclick="selectMode('pvc')">人机对战</button>
            <button class="mode-btn" id="online-btn" onclick="selectMode('online')">在线对战</button>
        </div>
        
        <div class="game-area active" id="game-area">
            <div class="status" id="status">玩家1 请选择</div>
            
            <div class="players">
                <div class="player player1">
                    <h3 id="player1-name">玩家1</h3>
                    <div class="choice" id="player1-choice">?</div>
                </div>
                <div class="player player2">
                    <h3 id="player2-name">玩家2</h3>
                    <div class="choice" id="player2-choice">?</div>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn" onclick="makeChoice('剪刀')">✌️ 剪刀</button>
                <button class="btn" onclick="makeChoice('石头')">✊ 石头</button>
                <button class="btn" onclick="makeChoice('布')">✋ 布</button>
            </div>
            
            <div class="result" id="result"></div>
            <button class="reset" id="reset" onclick="resetGame()">重新开始</button>
        </div>

        <div id="online-match-area" style="display: none;">
            <div class="room-input-container">
                <input type="text" class="room-input" id="room-key-input" placeholder="输入房间密钥" maxlength="20">
            </div>
            <button class="btn online-match-btn" id="join-btn" onclick="joinRoom()">加入房间</button>
            <div class="room-status" id="room-status"></div>
        </div>
    </div>

    <script>
        let gameMode = 'pvp';
        let currentPlayer = 1;
        let player1Choice = null;
        let player2Choice = null;
        let computerChoice = null;
        let ws = null;
        let myPlayerNumber = null;
        let roomId = null;
        let onlinePlayer1Choice = null;
        let onlinePlayer2Choice = null;
        const choices = ['剪刀', '石头', '布'];
        const emojis = {
            '剪刀': '✌️',
            '石头': '✊',
            '布': '✋'
        };

        function selectMode(mode) {
            gameMode = mode;
            
            const pvpBtn = document.getElementById('pvp-btn');
            const pvcBtn = document.getElementById('pvc-btn');
            const onlineBtn = document.getElementById('online-btn');
            const gameArea = document.getElementById('game-area');
            const onlineMatchArea = document.getElementById('online-match-area');
            
            pvpBtn.classList.remove('active');
            pvcBtn.classList.remove('active');
            onlineBtn.classList.remove('active');
            
            if (mode === 'pvp') {
                pvpBtn.classList.add('active');
                document.getElementById('player2-name').textContent = '玩家2';
                gameArea.style.display = 'block';
                onlineMatchArea.style.display = 'none';
            } else if (mode === 'pvc') {
                pvcBtn.classList.add('active');
                document.getElementById('player2-name').textContent = '电脑';
                gameArea.style.display = 'block';
                onlineMatchArea.style.display = 'none';
            } else {
                onlineBtn.classList.add('active');
                gameArea.style.display = 'none';
                onlineMatchArea.style.display = 'block';
                disconnectWebSocket();
            }
            
            resetGame();
        }

        function makeChoice(choice) {
            if (gameMode === 'pvp') {
                if (currentPlayer === 1) {
                    player1Choice = choice;
                    currentPlayer = 2;
                    document.getElementById('status').textContent = '玩家2 请选择';
                } else {
                    player2Choice = choice;
                    determineWinner();
                }
            } else if (gameMode === 'pvc') {
                player1Choice = choice;
                computerChoice = choices[Math.floor(Math.random() * choices.length)];
                player2Choice = computerChoice;
                determineWinner();
            } else if (gameMode === 'online') {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'makeChoice',
                        choice: choice
                    }));
                    
                    if (myPlayerNumber === 1) {
                        onlinePlayer1Choice = choice;
                        document.getElementById('status').textContent = '等待对手选择...';
                    } else {
                        onlinePlayer2Choice = choice;
                        document.getElementById('status').textContent = '等待对手选择...';
                    }
                }
            }
        }

        function determineWinner() {
            const resultDiv = document.getElementById('result');
            const statusDiv = document.getElementById('status');
            const buttons = document.querySelectorAll('.btn');
            const resetBtn = document.getElementById('reset');

            buttons.forEach(btn => btn.disabled = true);

            document.getElementById('player1-choice').textContent = emojis[player1Choice];
            document.getElementById('player2-choice').textContent = emojis[player2Choice];

            if (player1Choice === player2Choice) {
                resultDiv.textContent = '平局！';
                resultDiv.className = 'result draw';
            } else if (
                (player1Choice === '剪刀' && player2Choice === '布') ||
                (player1Choice === '石头' && player2Choice === '剪刀') ||
                (player1Choice === '布' && player2Choice === '石头')
            ) {
                resultDiv.textContent = gameMode === 'pvp' ? '玩家1 获胜！' : '你赢了！';
                resultDiv.className = 'result winner';
            } else {
                resultDiv.textContent = gameMode === 'pvp' ? '玩家2 获胜！' : '电脑赢了！';
                resultDiv.className = 'result winner';
            }

            resultDiv.style.display = 'block';
            statusDiv.textContent = '游戏结束';
            resetBtn.style.display = 'inline-block';
        }

        function resetGame() {
            currentPlayer = 1;
            player1Choice = null;
            player2Choice = null;
            computerChoice = null;
            onlinePlayer1Choice = null;
            onlinePlayer2Choice = null;

            document.getElementById('player1-choice').textContent = '?';
            document.getElementById('player2-choice').textContent = '?';
            
            if (gameMode === 'pvp') {
                document.getElementById('status').textContent = '玩家1 请选择';
            } else if (gameMode === 'pvc') {
                document.getElementById('status').textContent = '请选择';
            }
            
            document.getElementById('result').style.display = 'none';
            document.getElementById('reset').style.display = 'none';

            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = false);
        }

        function joinRoom() {
            const roomKeyInput = document.getElementById('room-key-input');
            const joinBtn = document.getElementById('join-btn');
            const roomStatus = document.getElementById('room-status');
            
            const roomKey = roomKeyInput.value.trim();
            
            if (!roomKey) {
                roomStatus.textContent = '请输入房间密钥';
                roomStatus.style.color = '#f44336';
                return;
            }
            
            joinBtn.disabled = true;
            roomStatus.textContent = '正在连接...';
            roomStatus.style.color = '#666';

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.hostname}:8080`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket连接成功');
                    ws.send(JSON.stringify({
                        type: 'joinRoom',
                        roomKey: roomKey
                    }));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    roomStatus.textContent = '连接服务器失败，请确保服务器已启动';
                    roomStatus.style.color = '#f44336';
                    joinBtn.disabled = false;
                };

                ws.onclose = () => {
                    console.log('WebSocket连接关闭');
                    joinBtn.disabled = false;
                    if (!gameArea.style.display || gameArea.style.display === 'none') {
                        roomStatus.textContent = '连接已断开';
                        roomStatus.style.color = '#f44336';
                    }
                };
            } else {
                ws.send(JSON.stringify({
                    type: 'joinRoom',
                    roomKey: roomKey
                }));
            }
        }

        function handleServerMessage(data) {
            const joinBtn = document.getElementById('join-btn');
            const roomStatus = document.getElementById('room-status');
            const gameArea = document.getElementById('game-area');
            const onlineMatchArea = document.getElementById('online-match-area');

            switch (data.type) {
                case 'error':
                    console.error('服务器错误:', data.message);
                    roomStatus.textContent = data.message;
                    roomStatus.style.color = '#f44336';
                    joinBtn.disabled = false;
                    break;

                case 'roomJoined':
                    console.log('加入房间成功！你是玩家' + data.playerNumber);
                    myPlayerNumber = data.playerNumber;
                    roomId = data.roomKey;
                    
                    roomStatus.textContent = data.message;
                    roomStatus.style.color = '#4caf50';
                    
                    if (data.playerNumber === 2) {
                        setTimeout(() => {
                            onlineMatchArea.style.display = 'none';
                            gameArea.style.display = 'block';
                            
                            document.getElementById('player1-name').textContent = '我';
                            document.getElementById('player2-name').textContent = '对手';
                            document.getElementById('status').textContent = '请选择';
                            
                            resetGame();
                        }, 1000);
                    }
                    break;

                case 'opponentJoined':
                    console.log('对手已加入');
                    roomStatus.textContent = data.message;
                    roomStatus.style.color = '#4caf50';
                    
                    setTimeout(() => {
                        onlineMatchArea.style.display = 'none';
                        gameArea.style.display = 'block';
                        
                        document.getElementById('player1-name').textContent = '我';
                        document.getElementById('player2-name').textContent = '对手';
                        document.getElementById('status').textContent = '请选择';
                        
                        resetGame();
                    }, 1000);
                    break;

                case 'opponentReady':
                    console.log('对手已选择');
                    document.getElementById('status').textContent = '对手已选择，请做出你的选择';
                    break;

                case 'gameResult':
                    console.log('游戏结果:', data);
                    
                    document.getElementById('player1-choice').textContent = emojis[data.player1Choice];
                    document.getElementById('player2-choice').textContent = emojis[data.player2Choice];
                    
                    const resultDiv = document.getElementById('result');
                    const statusDiv = document.getElementById('status');
                    const buttons = document.querySelectorAll('.btn');
                    const resetBtn = document.getElementById('reset');
                    
                    buttons.forEach(btn => btn.disabled = true);
                    
                    if (data.result === 'draw') {
                        resultDiv.textContent = '平局！';
                        resultDiv.className = 'result draw';
                    } else if ((data.result === 'player1' && myPlayerNumber === 1) || 
                               (data.result === 'player2' && myPlayerNumber === 2)) {
                        resultDiv.textContent = '你赢了！';
                        resultDiv.className = 'result winner';
                    } else {
                        resultDiv.textContent = '对手赢了！';
                        resultDiv.className = 'result winner';
                    }
                    
                    resultDiv.style.display = 'block';
                    statusDiv.textContent = '游戏结束';
                    resetBtn.style.display = 'inline-block';
                    break;

                case 'gameReset':
                    console.log('游戏重置');
                    resetGame();
                    document.getElementById('status').textContent = '请选择';
                    break;

                case 'opponentDisconnected':
                    alert('对手已断开连接');
                    selectMode('online');
                    break;
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.send(JSON.stringify({ type: 'disconnect' }));
                ws.close();
                ws = null;
            }
            myPlayerNumber = null;
            roomId = null;
            onlinePlayer1Choice = null;
            onlinePlayer2Choice = null;
            
            const roomStatus = document.getElementById('room-status');
            if (roomStatus) {
                roomStatus.textContent = '';
            }
            
            const joinBtn = document.getElementById('join-btn');
            if (joinBtn) {
                joinBtn.disabled = false;
            }
        }

        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
        });
    </script>
</body>
</html>